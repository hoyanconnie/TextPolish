name: Build and Release TextPolish

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€tagæ—¶è‡ªåŠ¨æ„å»º
on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v2.1.0 ç­‰ç‰ˆæœ¬æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.13'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: å®‰è£…Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        
    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        uv sync
        
    - name: æ„å»ºexeæ–‡ä»¶
      run: |
        # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "*.spec") { Remove-Item -Force "*.spec" }
        
        # ç›´æ¥ä½¿ç”¨PyInstalleræ„å»º
        uv run python -m PyInstaller --onefile --windowed --name=TextPolish --clean --noconfirm --add-data="icon.ico;." --icon=icon.ico main.py
        
    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        if (Test-Path "dist/TextPolish.exe") {
          Write-Host "âœ… æ„å»ºæˆåŠŸï¼exeæ–‡ä»¶å·²ç”Ÿæˆ"
          $fileSize = (Get-Item "dist/TextPolish.exe").Length
          $sizeMB = [math]::Round($fileSize / 1MB, 2)
          Write-Host "ğŸ“¦ æ–‡ä»¶å¤§å°: $sizeMB MB"
        } else {
          Write-Host "âŒ æ„å»ºå¤±è´¥ï¼æœªæ‰¾åˆ°exeæ–‡ä»¶"
          exit 1
        }
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TextPolish-Windows
        path: dist/TextPolish.exe
        retention-days: 30
        
    - name: åˆ›å»ºRelease
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/TextPolish.exe
        name: TextPolish ${{ github.ref_name }}
        body: |
          ## TextPolish ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **Windows**: [TextPolish.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/TextPolish.exe)
          
          ### ğŸ“ æ›´æ–°è¯´æ˜
          - âœ¨ **å®ç°ç”¨æˆ·å¯é…ç½®ç³»ç»Ÿ**ï¼šç§»é™¤æ—§çš„é™æ€é…ç½®

          ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
          - Gemini AIæ–‡æœ¬æ ¼å¼ä¿®å¤
          - ä¸€é”®å¤åˆ¶æ ¼å¼åŒ–æ–‡æœ¬
          - æ”¯æŒå¤šç§æ–‡æœ¬å¤„ç†æ¨¡å¼
          - ç°ä»£åŒ–ç”¨æˆ·ç•Œé¢
          
          ### ğŸ’» ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64ä½)
          - æ— éœ€å®‰è£…Pythonæˆ–å…¶ä»–ä¾èµ–
          
          ### ğŸ“– ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½ `TextPolish.exe`
          2. åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨
          3. æ— éœ€å®‰è£…ï¼Œç»¿è‰²ä¾¿æº
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - Gitæäº¤: ${{ github.sha }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
